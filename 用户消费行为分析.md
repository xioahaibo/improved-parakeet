

```python
import pandas as pd 
import numpy as np 
import seaborn as sns 
import matplotlib.pyplot as plt
```


```python
df=pd.read_csv('data.csv',encoding = "ISO-8859-1",dtype={'CustomerID':np.object})
df.head(20)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>536365</td>
      <td>85123A</td>
      <td>WHITE HANGING HEART T-LIGHT HOLDER</td>
      <td>6</td>
      <td>12/1/2010 8:26</td>
      <td>2.55</td>
      <td>17850</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>1</th>
      <td>536365</td>
      <td>71053</td>
      <td>WHITE METAL LANTERN</td>
      <td>6</td>
      <td>12/1/2010 8:26</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>2</th>
      <td>536365</td>
      <td>84406B</td>
      <td>CREAM CUPID HEARTS COAT HANGER</td>
      <td>8</td>
      <td>12/1/2010 8:26</td>
      <td>2.75</td>
      <td>17850</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>3</th>
      <td>536365</td>
      <td>84029G</td>
      <td>KNITTED UNION FLAG HOT WATER BOTTLE</td>
      <td>6</td>
      <td>12/1/2010 8:26</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>4</th>
      <td>536365</td>
      <td>84029E</td>
      <td>RED WOOLLY HOTTIE WHITE HEART.</td>
      <td>6</td>
      <td>12/1/2010 8:26</td>
      <td>3.39</td>
      <td>17850</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>5</th>
      <td>536365</td>
      <td>22752</td>
      <td>SET 7 BABUSHKA NESTING BOXES</td>
      <td>2</td>
      <td>12/1/2010 8:26</td>
      <td>7.65</td>
      <td>17850</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>6</th>
      <td>536365</td>
      <td>21730</td>
      <td>GLASS STAR FROSTED T-LIGHT HOLDER</td>
      <td>6</td>
      <td>12/1/2010 8:26</td>
      <td>4.25</td>
      <td>17850</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>7</th>
      <td>536366</td>
      <td>22633</td>
      <td>HAND WARMER UNION JACK</td>
      <td>6</td>
      <td>12/1/2010 8:28</td>
      <td>1.85</td>
      <td>17850</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>8</th>
      <td>536366</td>
      <td>22632</td>
      <td>HAND WARMER RED POLKA DOT</td>
      <td>6</td>
      <td>12/1/2010 8:28</td>
      <td>1.85</td>
      <td>17850</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>9</th>
      <td>536367</td>
      <td>84879</td>
      <td>ASSORTED COLOUR BIRD ORNAMENT</td>
      <td>32</td>
      <td>12/1/2010 8:34</td>
      <td>1.69</td>
      <td>13047</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>10</th>
      <td>536367</td>
      <td>22745</td>
      <td>POPPY'S PLAYHOUSE BEDROOM</td>
      <td>6</td>
      <td>12/1/2010 8:34</td>
      <td>2.10</td>
      <td>13047</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>11</th>
      <td>536367</td>
      <td>22748</td>
      <td>POPPY'S PLAYHOUSE KITCHEN</td>
      <td>6</td>
      <td>12/1/2010 8:34</td>
      <td>2.10</td>
      <td>13047</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>12</th>
      <td>536367</td>
      <td>22749</td>
      <td>FELTCRAFT PRINCESS CHARLOTTE DOLL</td>
      <td>8</td>
      <td>12/1/2010 8:34</td>
      <td>3.75</td>
      <td>13047</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>13</th>
      <td>536367</td>
      <td>22310</td>
      <td>IVORY KNITTED MUG COSY</td>
      <td>6</td>
      <td>12/1/2010 8:34</td>
      <td>1.65</td>
      <td>13047</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>14</th>
      <td>536367</td>
      <td>84969</td>
      <td>BOX OF 6 ASSORTED COLOUR TEASPOONS</td>
      <td>6</td>
      <td>12/1/2010 8:34</td>
      <td>4.25</td>
      <td>13047</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>15</th>
      <td>536367</td>
      <td>22623</td>
      <td>BOX OF VINTAGE JIGSAW BLOCKS</td>
      <td>3</td>
      <td>12/1/2010 8:34</td>
      <td>4.95</td>
      <td>13047</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>16</th>
      <td>536367</td>
      <td>22622</td>
      <td>BOX OF VINTAGE ALPHABET BLOCKS</td>
      <td>2</td>
      <td>12/1/2010 8:34</td>
      <td>9.95</td>
      <td>13047</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>17</th>
      <td>536367</td>
      <td>21754</td>
      <td>HOME BUILDING BLOCK WORD</td>
      <td>3</td>
      <td>12/1/2010 8:34</td>
      <td>5.95</td>
      <td>13047</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>18</th>
      <td>536367</td>
      <td>21755</td>
      <td>LOVE BUILDING BLOCK WORD</td>
      <td>3</td>
      <td>12/1/2010 8:34</td>
      <td>5.95</td>
      <td>13047</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>19</th>
      <td>536367</td>
      <td>21777</td>
      <td>RECIPE BOX WITH METAL HEART</td>
      <td>4</td>
      <td>12/1/2010 8:34</td>
      <td>7.95</td>
      <td>13047</td>
      <td>United Kingdom</td>
    </tr>
  </tbody>
</table>
</div>




```python
print(df.info())
print(df.shape)
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 541909 entries, 0 to 541908
    Data columns (total 8 columns):
    InvoiceNo      541909 non-null object
    StockCode      541909 non-null object
    Description    540455 non-null object
    Quantity       541909 non-null int64
    InvoiceDate    541909 non-null object
    UnitPrice      541909 non-null float64
    CustomerID     406829 non-null object
    Country        541909 non-null object
    dtypes: float64(1), int64(1), object(6)
    memory usage: 33.1+ MB
    None
    (541909, 8)
    


```python
#缺失值处理
df.isnull().any()
```




    InvoiceNo      False
    StockCode      False
    Description     True
    Quantity       False
    InvoiceDate    False
    UnitPrice      False
    CustomerID      True
    Country        False
    dtype: bool




```python
#清理顾客中的缺失值
df=df.dropna(axis=0,how='any',subset=['CustomerID'])#可以通过subset参数来删除在特定行中中含有空数据的全部行
df.info()
```

    <class 'pandas.core.frame.DataFrame'>
    Int64Index: 406829 entries, 0 to 541908
    Data columns (total 8 columns):
    InvoiceNo      406829 non-null object
    StockCode      406829 non-null object
    Description    406829 non-null object
    Quantity       406829 non-null int64
    InvoiceDate    406829 non-null object
    UnitPrice      406829 non-null float64
    CustomerID     406829 non-null object
    Country        406829 non-null object
    dtypes: float64(1), int64(1), object(6)
    memory usage: 27.9+ MB
    


```python
#需要将InvoiceDate的类型转换为时间格式：
df['InvoiceDate']=pd.to_datetime(df['InvoiceDate'],format='%m/%d/%Y %H:%M')
#找出异常值
df.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Quantity</th>
      <th>UnitPrice</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>406829.000000</td>
      <td>406829.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>12.061303</td>
      <td>3.460471</td>
    </tr>
    <tr>
      <th>std</th>
      <td>248.693370</td>
      <td>69.315162</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-80995.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>2.000000</td>
      <td>1.250000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>5.000000</td>
      <td>1.950000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>12.000000</td>
      <td>3.750000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>80995.000000</td>
      <td>38970.000000</td>
    </tr>
  </tbody>
</table>
</div>




```python
#购买数量中存在负值，查询数量少于0的订单
#df[df['Quantity']<0]
df.loc[df['Quantity']<0]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>141</th>
      <td>C536379</td>
      <td>D</td>
      <td>Discount</td>
      <td>-1</td>
      <td>2010-12-01 09:41:00</td>
      <td>27.50</td>
      <td>14527</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>154</th>
      <td>C536383</td>
      <td>35004C</td>
      <td>SET OF 3 COLOURED  FLYING DUCKS</td>
      <td>-1</td>
      <td>2010-12-01 09:49:00</td>
      <td>4.65</td>
      <td>15311</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>235</th>
      <td>C536391</td>
      <td>22556</td>
      <td>PLASTERS IN TIN CIRCUS PARADE</td>
      <td>-12</td>
      <td>2010-12-01 10:24:00</td>
      <td>1.65</td>
      <td>17548</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>236</th>
      <td>C536391</td>
      <td>21984</td>
      <td>PACK OF 12 PINK PAISLEY TISSUES</td>
      <td>-24</td>
      <td>2010-12-01 10:24:00</td>
      <td>0.29</td>
      <td>17548</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>237</th>
      <td>C536391</td>
      <td>21983</td>
      <td>PACK OF 12 BLUE PAISLEY TISSUES</td>
      <td>-24</td>
      <td>2010-12-01 10:24:00</td>
      <td>0.29</td>
      <td>17548</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>238</th>
      <td>C536391</td>
      <td>21980</td>
      <td>PACK OF 12 RED RETROSPOT TISSUES</td>
      <td>-24</td>
      <td>2010-12-01 10:24:00</td>
      <td>0.29</td>
      <td>17548</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>239</th>
      <td>C536391</td>
      <td>21484</td>
      <td>CHICK GREY HOT WATER BOTTLE</td>
      <td>-12</td>
      <td>2010-12-01 10:24:00</td>
      <td>3.45</td>
      <td>17548</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>240</th>
      <td>C536391</td>
      <td>22557</td>
      <td>PLASTERS IN TIN VINTAGE PAISLEY</td>
      <td>-12</td>
      <td>2010-12-01 10:24:00</td>
      <td>1.65</td>
      <td>17548</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>241</th>
      <td>C536391</td>
      <td>22553</td>
      <td>PLASTERS IN TIN SKULLS</td>
      <td>-24</td>
      <td>2010-12-01 10:24:00</td>
      <td>1.65</td>
      <td>17548</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>939</th>
      <td>C536506</td>
      <td>22960</td>
      <td>JAM MAKING SET WITH JARS</td>
      <td>-6</td>
      <td>2010-12-01 12:38:00</td>
      <td>4.25</td>
      <td>17897</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>1441</th>
      <td>C536543</td>
      <td>22632</td>
      <td>HAND WARMER RED RETROSPOT</td>
      <td>-1</td>
      <td>2010-12-01 14:30:00</td>
      <td>2.10</td>
      <td>17841</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>1442</th>
      <td>C536543</td>
      <td>22355</td>
      <td>CHARLOTTE BAG SUKI DESIGN</td>
      <td>-2</td>
      <td>2010-12-01 14:30:00</td>
      <td>0.85</td>
      <td>17841</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>1973</th>
      <td>C536548</td>
      <td>22244</td>
      <td>3 HOOK HANGER MAGIC GARDEN</td>
      <td>-4</td>
      <td>2010-12-01 14:33:00</td>
      <td>1.95</td>
      <td>12472</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>1974</th>
      <td>C536548</td>
      <td>22242</td>
      <td>5 HOOK HANGER MAGIC TOADSTOOL</td>
      <td>-5</td>
      <td>2010-12-01 14:33:00</td>
      <td>1.65</td>
      <td>12472</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>1975</th>
      <td>C536548</td>
      <td>20914</td>
      <td>SET/5 RED RETROSPOT LID GLASS BOWLS</td>
      <td>-1</td>
      <td>2010-12-01 14:33:00</td>
      <td>2.95</td>
      <td>12472</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>1976</th>
      <td>C536548</td>
      <td>22892</td>
      <td>SET OF SALT AND PEPPER TOADSTOOLS</td>
      <td>-7</td>
      <td>2010-12-01 14:33:00</td>
      <td>1.25</td>
      <td>12472</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>1977</th>
      <td>C536548</td>
      <td>22654</td>
      <td>DELUXE SEWING KIT</td>
      <td>-1</td>
      <td>2010-12-01 14:33:00</td>
      <td>5.95</td>
      <td>12472</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>1978</th>
      <td>C536548</td>
      <td>22767</td>
      <td>TRIPLE PHOTO FRAME CORNICE</td>
      <td>-2</td>
      <td>2010-12-01 14:33:00</td>
      <td>9.95</td>
      <td>12472</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>1979</th>
      <td>C536548</td>
      <td>22333</td>
      <td>RETROSPOT PARTY BAG + STICKER SET</td>
      <td>-1</td>
      <td>2010-12-01 14:33:00</td>
      <td>1.65</td>
      <td>12472</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>1980</th>
      <td>C536548</td>
      <td>22245</td>
      <td>HOOK, 1 HANGER ,MAGIC GARDEN</td>
      <td>-2</td>
      <td>2010-12-01 14:33:00</td>
      <td>0.85</td>
      <td>12472</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>1981</th>
      <td>C536548</td>
      <td>22077</td>
      <td>6 RIBBONS RUSTIC CHARM</td>
      <td>-6</td>
      <td>2010-12-01 14:33:00</td>
      <td>1.65</td>
      <td>12472</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>1982</th>
      <td>C536548</td>
      <td>22631</td>
      <td>CIRCUS PARADE LUNCH BOX</td>
      <td>-1</td>
      <td>2010-12-01 14:33:00</td>
      <td>1.95</td>
      <td>12472</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>1983</th>
      <td>C536548</td>
      <td>22168</td>
      <td>ORGANISER WOOD ANTIQUE WHITE</td>
      <td>-2</td>
      <td>2010-12-01 14:33:00</td>
      <td>8.50</td>
      <td>12472</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>1984</th>
      <td>C536548</td>
      <td>21218</td>
      <td>RED SPOTTY BISCUIT TIN</td>
      <td>-3</td>
      <td>2010-12-01 14:33:00</td>
      <td>3.75</td>
      <td>12472</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>1985</th>
      <td>C536548</td>
      <td>20957</td>
      <td>PORCELAIN HANGING BELL SMALL</td>
      <td>-1</td>
      <td>2010-12-01 14:33:00</td>
      <td>1.45</td>
      <td>12472</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>1986</th>
      <td>C536548</td>
      <td>22580</td>
      <td>ADVENT CALENDAR GINGHAM SACK</td>
      <td>-4</td>
      <td>2010-12-01 14:33:00</td>
      <td>5.95</td>
      <td>12472</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>3170</th>
      <td>C536606</td>
      <td>20914</td>
      <td>SET/5 RED RETROSPOT LID GLASS BOWLS</td>
      <td>-2</td>
      <td>2010-12-02 09:10:00</td>
      <td>2.95</td>
      <td>14092</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>3338</th>
      <td>C536622</td>
      <td>22752</td>
      <td>SET 7 BABUSHKA NESTING BOXES</td>
      <td>-2</td>
      <td>2010-12-02 10:37:00</td>
      <td>8.50</td>
      <td>12471</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>3410</th>
      <td>C536625</td>
      <td>22839</td>
      <td>3 TIER CAKE TIN GREEN AND CREAM</td>
      <td>-2</td>
      <td>2010-12-02 10:46:00</td>
      <td>14.95</td>
      <td>14766</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>3693</th>
      <td>C536642</td>
      <td>21463</td>
      <td>MIRRORED DISCO BALL</td>
      <td>-1</td>
      <td>2010-12-02 11:56:00</td>
      <td>5.95</td>
      <td>14390</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>538564</th>
      <td>C581409</td>
      <td>82482</td>
      <td>WOODEN PICTURE FRAME WHITE FINISH</td>
      <td>-1</td>
      <td>2011-12-08 14:08:00</td>
      <td>2.95</td>
      <td>12476</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>538565</th>
      <td>C581409</td>
      <td>22173</td>
      <td>METAL 4 HOOK HANGER FRENCH CHATEAU</td>
      <td>-2</td>
      <td>2011-12-08 14:08:00</td>
      <td>3.29</td>
      <td>12476</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>538566</th>
      <td>C581409</td>
      <td>85199L</td>
      <td>LARGE HANGING IVORY &amp; RED WOOD BIRD</td>
      <td>-1</td>
      <td>2011-12-08 14:08:00</td>
      <td>0.65</td>
      <td>12476</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>538567</th>
      <td>C581409</td>
      <td>85127</td>
      <td>SMALL SQUARE CUT GLASS CANDLESTICK</td>
      <td>-5</td>
      <td>2011-12-08 14:08:00</td>
      <td>4.95</td>
      <td>12476</td>
      <td>Germany</td>
    </tr>
    <tr>
      <th>540072</th>
      <td>C581460</td>
      <td>22197</td>
      <td>POPCORN HOLDER</td>
      <td>-5</td>
      <td>2011-12-08 18:48:00</td>
      <td>0.72</td>
      <td>13078</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540073</th>
      <td>C581460</td>
      <td>22107</td>
      <td>PIZZA PLATE IN BOX</td>
      <td>-1</td>
      <td>2011-12-08 18:48:00</td>
      <td>1.25</td>
      <td>13078</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540078</th>
      <td>C581462</td>
      <td>16219</td>
      <td>HOUSE SHAPE PENCIL SHARPENER</td>
      <td>-48</td>
      <td>2011-12-08 18:51:00</td>
      <td>0.06</td>
      <td>12985</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540079</th>
      <td>C581462</td>
      <td>21642</td>
      <td>ASSORTED TUTTI FRUTTI PEN</td>
      <td>-72</td>
      <td>2011-12-08 18:51:00</td>
      <td>0.29</td>
      <td>12985</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540080</th>
      <td>C581463</td>
      <td>85048</td>
      <td>15CM CHRISTMAS GLASS BALL 20 LIGHTS</td>
      <td>-2</td>
      <td>2011-12-08 18:56:00</td>
      <td>7.95</td>
      <td>17526</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540081</th>
      <td>C581464</td>
      <td>23458</td>
      <td>DOLLY CABINET 3 DRAWERS</td>
      <td>-1</td>
      <td>2011-12-08 18:57:00</td>
      <td>14.95</td>
      <td>15951</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540082</th>
      <td>C581464</td>
      <td>71477</td>
      <td>COLOURED GLASS STAR T-LIGHT HOLDER</td>
      <td>-6</td>
      <td>2011-12-08 18:57:00</td>
      <td>3.95</td>
      <td>15951</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540083</th>
      <td>C581465</td>
      <td>23660</td>
      <td>HENRIETTA HEN MUG</td>
      <td>-2</td>
      <td>2011-12-08 18:59:00</td>
      <td>1.65</td>
      <td>15755</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540084</th>
      <td>C581465</td>
      <td>22171</td>
      <td>3 HOOK PHOTO SHELF ANTIQUE WHITE</td>
      <td>-1</td>
      <td>2011-12-08 18:59:00</td>
      <td>8.50</td>
      <td>15755</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540085</th>
      <td>C581465</td>
      <td>21876</td>
      <td>POTTERING MUG</td>
      <td>-4</td>
      <td>2011-12-08 18:59:00</td>
      <td>1.65</td>
      <td>15755</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540086</th>
      <td>C581465</td>
      <td>20914</td>
      <td>SET/5 RED RETROSPOT LID GLASS BOWLS</td>
      <td>-3</td>
      <td>2011-12-08 18:59:00</td>
      <td>2.95</td>
      <td>15755</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540087</th>
      <td>C581466</td>
      <td>22838</td>
      <td>3 TIER CAKE TIN RED AND CREAM</td>
      <td>-1</td>
      <td>2011-12-08 19:20:00</td>
      <td>14.95</td>
      <td>13883</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540088</th>
      <td>C581466</td>
      <td>22720</td>
      <td>SET OF 3 CAKE TINS PANTRY DESIGN</td>
      <td>-2</td>
      <td>2011-12-08 19:20:00</td>
      <td>4.95</td>
      <td>13883</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540089</th>
      <td>C581466</td>
      <td>21216</td>
      <td>SET 3 RETROSPOT TEA,COFFEE,SUGAR</td>
      <td>-1</td>
      <td>2011-12-08 19:20:00</td>
      <td>4.95</td>
      <td>13883</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540090</th>
      <td>C581466</td>
      <td>21535</td>
      <td>RED RETROSPOT SMALL MILK JUG</td>
      <td>-2</td>
      <td>2011-12-08 19:20:00</td>
      <td>2.55</td>
      <td>13883</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540091</th>
      <td>C581466</td>
      <td>21232</td>
      <td>STRAWBERRY CERAMIC TRINKET POT</td>
      <td>-1</td>
      <td>2011-12-08 19:20:00</td>
      <td>1.25</td>
      <td>13883</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540141</th>
      <td>C581468</td>
      <td>21314</td>
      <td>SMALL GLASS HEART TRINKET POT</td>
      <td>-10</td>
      <td>2011-12-08 19:26:00</td>
      <td>2.10</td>
      <td>13599</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540142</th>
      <td>C581468</td>
      <td>22098</td>
      <td>BOUDOIR SQUARE TISSUE BOX</td>
      <td>-12</td>
      <td>2011-12-08 19:26:00</td>
      <td>0.39</td>
      <td>13599</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540176</th>
      <td>C581470</td>
      <td>23084</td>
      <td>RABBIT NIGHT LIGHT</td>
      <td>-4</td>
      <td>2011-12-08 19:28:00</td>
      <td>2.08</td>
      <td>17924</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540422</th>
      <td>C581484</td>
      <td>23843</td>
      <td>PAPER CRAFT , LITTLE BIRDIE</td>
      <td>-80995</td>
      <td>2011-12-09 09:27:00</td>
      <td>2.08</td>
      <td>16446</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540448</th>
      <td>C581490</td>
      <td>22178</td>
      <td>VICTORIAN GLASS HANGING T-LIGHT</td>
      <td>-12</td>
      <td>2011-12-09 09:57:00</td>
      <td>1.95</td>
      <td>14397</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>540449</th>
      <td>C581490</td>
      <td>23144</td>
      <td>ZINC T-LIGHT HOLDER STARS SMALL</td>
      <td>-11</td>
      <td>2011-12-09 09:57:00</td>
      <td>0.83</td>
      <td>14397</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>541541</th>
      <td>C581499</td>
      <td>M</td>
      <td>Manual</td>
      <td>-1</td>
      <td>2011-12-09 10:28:00</td>
      <td>224.69</td>
      <td>15498</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>541715</th>
      <td>C581568</td>
      <td>21258</td>
      <td>VICTORIAN SEWING BOX LARGE</td>
      <td>-5</td>
      <td>2011-12-09 11:57:00</td>
      <td>10.95</td>
      <td>15311</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>541716</th>
      <td>C581569</td>
      <td>84978</td>
      <td>HANGING HEART JAR T-LIGHT HOLDER</td>
      <td>-1</td>
      <td>2011-12-09 11:58:00</td>
      <td>1.25</td>
      <td>17315</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>541717</th>
      <td>C581569</td>
      <td>20979</td>
      <td>36 PENCILS TUBE RED RETROSPOT</td>
      <td>-5</td>
      <td>2011-12-09 11:58:00</td>
      <td>1.25</td>
      <td>17315</td>
      <td>United Kingdom</td>
    </tr>
  </tbody>
</table>
<p>8905 rows × 8 columns</p>
</div>




```python
#订单都是以C开头，为退货订单，
#3. 对购买数量、商品单价中的离群值采用进行处理（基于箱线图）
#求出Quantity的25%和75%分位数
quan_q1=df['Quantity'].quantile(0.25)
quan_q3=df['Quantity'].quantile(0.75)
quan_iqr=quan_q3-quan_q1
#求出UnitPrice的25%和75%分位数
up_q1=df['UnitPrice'].quantile(0.25)
up_q3=df['UnitPrice'].quantile(0.75)
up_iqr=up_q3-up_q1
df=df[(df['Quantity']>(quan_q1-1.5*quan_iqr))&(df['Quantity']<(quan_q3+1.5*quan_iqr))]
df=df[(df['UnitPrice']>(up_q1-1.5*up_iqr))&(df['UnitPrice']<(up_q3+1.5*up_iqr))]
df.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Quantity</th>
      <th>UnitPrice</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>343712.000000</td>
      <td>343712.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>7.286964</td>
      <td>2.191766</td>
    </tr>
    <tr>
      <th>std</th>
      <td>6.878460</td>
      <td>1.533390</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-12.000000</td>
      <td>0.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>2.000000</td>
      <td>1.250000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>5.000000</td>
      <td>1.650000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>12.000000</td>
      <td>2.950000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>26.000000</td>
      <td>7.460000</td>
    </tr>
  </tbody>
</table>
</div>




```python
#逻辑性整理
#由于后续需要用到购买日期、购买月份、总金额进行分析，分别计算出这些值
df['Date']=df.InvoiceDate.dt.date
df['Month']=df.Date.values.astype('datetime64[M]')#将日期转换为月份
df['Amount']=df['Quantity']*df['UnitPrice']
#数量和总金额中仍然后小于或等于0的数，新建一个对象，提取这两个字段均大于0的数值
df_order=df[(df['Quantity']>0)&(df['Amount']>0)]
df_order.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Quantity</th>
      <th>UnitPrice</th>
      <th>Amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>337527.000000</td>
      <td>337527.000000</td>
      <td>337527.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>7.482604</td>
      <td>2.182949</td>
      <td>12.754708</td>
    </tr>
    <tr>
      <th>std</th>
      <td>6.769440</td>
      <td>1.530358</td>
      <td>13.143836</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000000</td>
      <td>0.001000</td>
      <td>0.001000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>2.000000</td>
      <td>1.250000</td>
      <td>3.750000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>6.000000</td>
      <td>1.650000</td>
      <td>10.080000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>12.000000</td>
      <td>2.950000</td>
      <td>17.400000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>26.000000</td>
      <td>7.460000</td>
      <td>178.800000</td>
    </tr>
  </tbody>
</table>
</div>




```python
#3原数据集中的粒度为购买的产品，将粒度修改为订单（下单时间、顾客ID相同的数据视为同意订单）

df_order = df_order.groupby(['Date','Month','CustomerID','InvoiceNo']).sum().reset_index()
df_order=df_order.drop(['UnitPrice'],axis=1)  #删除列UnitPrice
df_order.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Quantity</th>
      <th>Amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>16820.000000</td>
      <td>16820.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>150.153448</td>
      <td>255.948769</td>
    </tr>
    <tr>
      <th>std</th>
      <td>154.504744</td>
      <td>253.393595</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000000</td>
      <td>0.001000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>52.000000</td>
      <td>105.032500</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>109.000000</td>
      <td>196.940000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>201.000000</td>
      <td>326.052500</td>
    </tr>
    <tr>
      <th>max</th>
      <td>2515.000000</td>
      <td>4721.740000</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_order.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 16820 entries, 0 to 16819
    Data columns (total 6 columns):
    Date          16820 non-null object
    Month         16820 non-null datetime64[ns]
    CustomerID    16820 non-null object
    InvoiceNo     16820 non-null object
    Quantity      16820 non-null int64
    Amount        16820 non-null float64
    dtypes: datetime64[ns](1), float64(1), int64(1), object(3)
    memory usage: 788.5+ KB
    


```python
#整体数据分析
#为了显示更直观，关闭科学计数法
pd.set_option('display.float_format',lambda x :"%.5f" %x)
df_order.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Quantity</th>
      <th>Amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>16820.00000</td>
      <td>16820.00000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>150.15345</td>
      <td>255.94877</td>
    </tr>
    <tr>
      <th>std</th>
      <td>154.50474</td>
      <td>253.39359</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.00000</td>
      <td>0.00100</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>52.00000</td>
      <td>105.03250</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>109.00000</td>
      <td>196.94000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>201.00000</td>
      <td>326.05250</td>
    </tr>
    <tr>
      <th>max</th>
      <td>2515.00000</td>
      <td>4721.74000</td>
    </tr>
  </tbody>
</table>
</div>



平均每位顾客购买150个商品，标准差为154，波动性较大，中位数在109，75分位数在201个，而最大值为2515，说明绝大多数商品的购买数量在200个以内，而购买总额的情况和购买数量类似，大部分集中在相对来说小额订单

#消费趋势分析
按照月作为维度，新建对象，计算每月的购买人数CustomerNumber，订单数InvoiceNumber，销量Quantity，销售额Amount


```python
df_order_month=df_order.groupby('Month').agg({'CustomerID':'nunique','InvoiceNo':'count','Quantity':'sum','Amount':'sum'}).reset_index() \
        .rename(columns={'CustomerID':'CustomerNumber','InvoiceNo':'InvoiceNumber'})
df_order_month
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Month</th>
      <th>CustomerNumber</th>
      <th>InvoiceNumber</th>
      <th>Quantity</th>
      <th>Amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2010-12-01</td>
      <td>833</td>
      <td>1270</td>
      <td>151041</td>
      <td>285922.51000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2011-01-01</td>
      <td>701</td>
      <td>904</td>
      <td>136196</td>
      <td>233582.36000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2011-02-01</td>
      <td>703</td>
      <td>895</td>
      <td>127465</td>
      <td>220022.76000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2011-03-01</td>
      <td>919</td>
      <td>1198</td>
      <td>170166</td>
      <td>286204.84000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2011-04-01</td>
      <td>805</td>
      <td>1034</td>
      <td>146977</td>
      <td>242647.86100</td>
    </tr>
    <tr>
      <th>5</th>
      <td>2011-05-01</td>
      <td>1001</td>
      <td>1388</td>
      <td>185214</td>
      <td>324323.71000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>2011-06-01</td>
      <td>939</td>
      <td>1267</td>
      <td>172345</td>
      <td>289946.81000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>2011-07-01</td>
      <td>902</td>
      <td>1213</td>
      <td>180350</td>
      <td>288700.39100</td>
    </tr>
    <tr>
      <th>8</th>
      <td>2011-08-01</td>
      <td>878</td>
      <td>1150</td>
      <td>187823</td>
      <td>305047.43000</td>
    </tr>
    <tr>
      <th>9</th>
      <td>2011-09-01</td>
      <td>1194</td>
      <td>1596</td>
      <td>282713</td>
      <td>479858.24200</td>
    </tr>
    <tr>
      <th>10</th>
      <td>2011-10-01</td>
      <td>1319</td>
      <td>1741</td>
      <td>304249</td>
      <td>525360.72000</td>
    </tr>
    <tr>
      <th>11</th>
      <td>2011-11-01</td>
      <td>1598</td>
      <td>2446</td>
      <td>373841</td>
      <td>645961.89000</td>
    </tr>
    <tr>
      <th>12</th>
      <td>2011-12-01</td>
      <td>587</td>
      <td>718</td>
      <td>107201</td>
      <td>177478.77000</td>
    </tr>
  </tbody>
</table>
</div>




```python
df_order_month.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 13 entries, 0 to 12
    Data columns (total 5 columns):
    Month             13 non-null datetime64[ns]
    CustomerNumber    13 non-null int64
    InvoiceNumber     13 non-null int64
    Quantity          13 non-null int64
    Amount            13 non-null float64
    dtypes: datetime64[ns](1), float64(1), int64(3)
    memory usage: 600.0 bytes
    


```python
#绘制图表，显示月销量、销售额、购买人数、订单数的变化趋势
fig,ax1=plt.subplots(figsize=(18,10))
#制作一个兄弟轴
ax2=ax1.twinx()##制作一个兄弟轴
#ax1:ax1:y轴为销量、销售额；ax2：y轴为购买人数，订单数
l1,=ax1.plot(df_order_month['Month'],df_order_month['Quantity'],'r-')
l2,=ax1.plot(df_order_month['Month'], df_order_month['Amount'], 'g-')
l3,=ax2.plot(df_order_month['Month'], df_order_month['CustomerNumber'], 'b--')
l4,=ax2.plot(df_order_month['Month'], df_order_month['InvoiceNumber'], 'y--')
#设置坐标标签
ax1.set_ylabel('销量、销售额')
ax2.set_ylabel('购买人数，订单数')
ax1.set_xlabel('月份')
#设置统计图标题
plt.title('月销量、销售额、购买人数、订单数变化趋势')
#设置图例
plt.legend(handles=[l1, l2, l3, l4])
```

    d:\Users\whb\AppData\Local\Continuum\anaconda3\lib\site-packages\pandas\plotting\_converter.py:129: FutureWarning: Using an implicitly registered datetime converter for a matplotlib plotting method. The converter was registered by pandas on import. Future versions of pandas will require you to explicitly register matplotlib converters.
    
    To register the converters:
    	>>> from pandas.plotting import register_matplotlib_converters
    	>>> register_matplotlib_converters()
      warnings.warn(msg, FutureWarning)
    




    <matplotlib.legend.Legend at 0x2341ef57240>




![png](output_16_2.png)


销量、销售额、购买人数、订单数的变化趋势基本趋致，随着时间，数据开始涨高，而在11月时达到峰值，假设1：数据异常，2：由于促销活动。但是由于手头上仅有销售数据，无法进行判断。


```python
#复购率、回购率
#先将用户的消费数据进行数据透视，新建透视表以统计每个用户每月的订单量
pivoted_counts=df_order.pivot_table(index='CustomerID',columns='Month',values='InvoiceNo',aggfunc='count').fillna(0)
columns_month=df_order.Month.sort_values().astype('str').unique()
pivoted_counts.columns=columns_month
pivoted_counts
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>2010-12-01</th>
      <th>2011-01-01</th>
      <th>2011-02-01</th>
      <th>2011-03-01</th>
      <th>2011-04-01</th>
      <th>2011-05-01</th>
      <th>2011-06-01</th>
      <th>2011-07-01</th>
      <th>2011-08-01</th>
      <th>2011-09-01</th>
      <th>2011-10-01</th>
      <th>2011-11-01</th>
      <th>2011-12-01</th>
    </tr>
    <tr>
      <th>CustomerID</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>12347</th>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
    </tr>
    <tr>
      <th>12348</th>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12349</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12350</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12352</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>3.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>2.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12353</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12354</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12355</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12356</th>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12357</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12358</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
    </tr>
    <tr>
      <th>12359</th>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12360</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12361</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12362</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>3.00000</td>
      <td>1.00000</td>
      <td>1.00000</td>
    </tr>
    <tr>
      <th>12363</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12364</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
    </tr>
    <tr>
      <th>12365</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12367</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
    </tr>
    <tr>
      <th>12370</th>
      <td>2.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12371</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12372</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12373</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12374</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12375</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12377</th>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12378</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12379</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12380</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12381</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>2.00000</td>
      <td>1.00000</td>
      <td>1.00000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>18240</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18241</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>2.00000</td>
      <td>1.00000</td>
      <td>6.00000</td>
      <td>3.00000</td>
      <td>3.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18242</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>2.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>2.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18245</th>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>2.00000</td>
      <td>0.00000</td>
      <td>2.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
    </tr>
    <tr>
      <th>18246</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18248</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18249</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18250</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18252</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18255</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18257</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>2.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>3.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18259</th>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18260</th>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18261</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18262</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18263</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18265</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18269</th>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18270</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18272</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>2.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
    </tr>
    <tr>
      <th>18273</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
    </tr>
    <tr>
      <th>18274</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18276</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18277</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18278</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18280</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18281</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>18282</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
    </tr>
    <tr>
      <th>18283</th>
      <td>0.00000</td>
      <td>2.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>2.00000</td>
      <td>2.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>1.00000</td>
      <td>4.00000</td>
      <td>1.00000</td>
    </tr>
    <tr>
      <th>18287</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>2.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
  </tbody>
</table>
<p>4190 rows × 13 columns</p>
</div>




```python
#. 计算复购率
#复购率：在某个时间窗口上，产生两个及以上订单的用户在所有消费用户中的占比。
#将数据转换一下，消费两次及以上记为1，消费一次记为0，没有消费记为NaN：
pivoted_counts_transf=pivoted_counts.applymap(lambda x :1 if x>1 else np.NaN if x==0 else 0 )
pivoted_counts_transf.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>2010-12-01</th>
      <th>2011-01-01</th>
      <th>2011-02-01</th>
      <th>2011-03-01</th>
      <th>2011-04-01</th>
      <th>2011-05-01</th>
      <th>2011-06-01</th>
      <th>2011-07-01</th>
      <th>2011-08-01</th>
      <th>2011-09-01</th>
      <th>2011-10-01</th>
      <th>2011-11-01</th>
      <th>2011-12-01</th>
    </tr>
    <tr>
      <th>CustomerID</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>12347</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>12348</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
    </tr>
    <tr>
      <th>12349</th>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>nan</td>
    </tr>
    <tr>
      <th>12350</th>
      <td>nan</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
    </tr>
    <tr>
      <th>12352</th>
      <td>nan</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>1.00000</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>1.00000</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>nan</td>
    </tr>
  </tbody>
</table>
</div>




```python
#用sum计算复购人数，用count计算总消费人数，用sum得出的数据除以count的，绘制折线图：
df_order_fugou=(pivoted_counts_transf.sum()/pivoted_counts_transf.count())#.apply(lambda x :format(x,'.2%'))
df_order_fugou.plot(figsize=(10,5),color='r',title='月复购率')

```




    <matplotlib.axes._subplots.AxesSubplot at 0x2342c2fed68>




![png](output_20_1.png)


复购率有两个峰值，一个是2010年的12月，达到28%，另一个是2011年的11月，达到30%，都是一年的年尾时段，而在2011年1月至2011年10月这段时间内。数据跟每月分析的数据基本吻合，可以排除数据异常的情况，波动是和营销活动有较大的关系。

回购率：在某两个连续的时间窗口均有消费记录的用户在前一个时间窗口中所有消费用户数的占比。，下面开始分析回购情况


```python
#对pivoted_counts数据透视表进行处理，回购行为记为1，消费非回购行为记为0，无消费记为NaN：
def repurchaseRate(data):
    status = []
    for i in range(12):
        if data[i] >= 1:
            if data[i+1] >= 1:
                status.append(1)         
            if data[i+1] == 0:
                status.append(0)           
        else:
            status.append(np.NaN)         
    status.append(np.NaN)
    return pd.Series(status, index=columns_month)
pivoted_repurchase = pivoted_counts.apply(repurchaseRate, axis=1)
pivoted_repurchase.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>2010-12-01</th>
      <th>2011-01-01</th>
      <th>2011-02-01</th>
      <th>2011-03-01</th>
      <th>2011-04-01</th>
      <th>2011-05-01</th>
      <th>2011-06-01</th>
      <th>2011-07-01</th>
      <th>2011-08-01</th>
      <th>2011-09-01</th>
      <th>2011-10-01</th>
      <th>2011-11-01</th>
      <th>2011-12-01</th>
    </tr>
    <tr>
      <th>CustomerID</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>12347</th>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>nan</td>
    </tr>
    <tr>
      <th>12348</th>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
    </tr>
    <tr>
      <th>12349</th>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>nan</td>
    </tr>
    <tr>
      <th>12350</th>
      <td>nan</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
    </tr>
    <tr>
      <th>12352</th>
      <td>nan</td>
      <td>nan</td>
      <td>1.00000</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>nan</td>
      <td>0.00000</td>
      <td>nan</td>
    </tr>
  </tbody>
</table>
</div>




```python
(pivoted_repurchase.sum()/pivoted_repurchase.count()).plot(figsize=(12,8),title='月回购率')
```




    <matplotlib.axes._subplots.AxesSubplot at 0x2341f032e80>




![png](output_24_1.png)


在2010年12 月至2011年的10月，回购率大部分处于35%以上，结合月销售额统计可以看出，回购率月销量、销售额的关系非常明显，比如8，10月达到回购率的峰值，那么9 11 月份的销量，销售额出现大幅增长，可以看出做好老客户的维护非常重要。

用户分层
按照用户的消费行为对用户进行分层，分别是：新用户、活跃用户、不活跃用户、回流用户。

新用户的定义是第一次消费，活跃用户是连续两个时间窗口有消费记录的用户，不活跃用户是当前时间窗口内没有消费记录的老用户。回流用户是在在当前时间窗口内有过消费过的不活跃用户，流失用户是连续两个及以上时间窗口没有消费记录的用户；以上的时间窗口都是按月统计。




```python
#unreg为不是新消用户，new为新用户，unactive为不活跃用户，active为活跃用户，lost为流失用户，return为回流用户
def purchase_status(data):
    status=[]
    for i in range(13):
        #若本月没有消费：
        if data[i]==0:
            if len(status)>0:
                if status[i-1]=='unreg':#若在上一个时间窗口定义为不是新消，此时间窗口定义为不是新消
                    status.append('unreg') 
                elif status[i-1]=='unactive':
                    status.append('lost')#若在上一个时间窗口定义为不活跃用户，此时间窗口定义为流失用户
                elif status[i-1]=='lost':
                    status.append('lost')#若在上一个时间窗口定义为流失用户，此时间窗口定义为流失用户
                else:
                    status.append('unactive') #若在上一个时间窗口定义为活跃用户/回流用户/新用户，此时间窗口定义为不活跃用户
            else:
                status.append('unreg')
        #若本月消费
        else:
            if len(status)==0:
                status.append('new')
            else:
                if status[i-1]=='unactive' or status[i-1]=='lost':
                    status.append('return')
                elif status[i-1] == 'unreg':
                    status.append('new')
                else:
                    status.append('active')
    return pd.Series(status, index=columns_month)
pivoted_purchase_status = pivoted_counts.apply(purchase_status, axis = 1)
pivoted_purchase_status
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>2010-12-01</th>
      <th>2011-01-01</th>
      <th>2011-02-01</th>
      <th>2011-03-01</th>
      <th>2011-04-01</th>
      <th>2011-05-01</th>
      <th>2011-06-01</th>
      <th>2011-07-01</th>
      <th>2011-08-01</th>
      <th>2011-09-01</th>
      <th>2011-10-01</th>
      <th>2011-11-01</th>
      <th>2011-12-01</th>
    </tr>
    <tr>
      <th>CustomerID</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>12347</th>
      <td>new</td>
      <td>active</td>
      <td>unactive</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>return</td>
      <td>unactive</td>
      <td>return</td>
      <td>unactive</td>
      <td>return</td>
      <td>unactive</td>
      <td>return</td>
    </tr>
    <tr>
      <th>12348</th>
      <td>new</td>
      <td>active</td>
      <td>unactive</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12349</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
    </tr>
    <tr>
      <th>12350</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12352</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>active</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>return</td>
      <td>unactive</td>
    </tr>
    <tr>
      <th>12353</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12354</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12355</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12356</th>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12357</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
    </tr>
    <tr>
      <th>12358</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>return</td>
    </tr>
    <tr>
      <th>12359</th>
      <td>unreg</td>
      <td>new</td>
      <td>active</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12360</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12361</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12362</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
      <td>return</td>
      <td>active</td>
      <td>active</td>
      <td>active</td>
      <td>active</td>
      <td>active</td>
    </tr>
    <tr>
      <th>12363</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12364</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>return</td>
      <td>unactive</td>
      <td>return</td>
    </tr>
    <tr>
      <th>12365</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12367</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
    </tr>
    <tr>
      <th>12370</th>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12371</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12372</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12373</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12374</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
    </tr>
    <tr>
      <th>12375</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>return</td>
      <td>unactive</td>
    </tr>
    <tr>
      <th>12377</th>
      <td>new</td>
      <td>active</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12378</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12379</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>12380</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>return</td>
      <td>active</td>
      <td>active</td>
      <td>unactive</td>
    </tr>
    <tr>
      <th>12381</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>return</td>
      <td>active</td>
      <td>active</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>18240</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18241</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>active</td>
      <td>active</td>
      <td>active</td>
      <td>active</td>
      <td>active</td>
      <td>active</td>
      <td>unactive</td>
    </tr>
    <tr>
      <th>18242</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18245</th>
      <td>new</td>
      <td>active</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>return</td>
    </tr>
    <tr>
      <th>18246</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18248</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18249</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
    </tr>
    <tr>
      <th>18250</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18252</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18255</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18257</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>return</td>
      <td>active</td>
      <td>unactive</td>
      <td>return</td>
      <td>unactive</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18259</th>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>return</td>
      <td>unactive</td>
    </tr>
    <tr>
      <th>18260</th>
      <td>new</td>
      <td>active</td>
      <td>unactive</td>
      <td>return</td>
      <td>active</td>
      <td>active</td>
      <td>active</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18261</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>active</td>
      <td>unactive</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18262</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18263</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
    </tr>
    <tr>
      <th>18265</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18269</th>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18270</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
    </tr>
    <tr>
      <th>18272</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>return</td>
      <td>active</td>
      <td>unactive</td>
      <td>return</td>
      <td>unactive</td>
      <td>return</td>
    </tr>
    <tr>
      <th>18273</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>return</td>
    </tr>
    <tr>
      <th>18274</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
    </tr>
    <tr>
      <th>18276</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18277</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18278</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18280</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18281</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
    </tr>
    <tr>
      <th>18282</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>return</td>
    </tr>
    <tr>
      <th>18283</th>
      <td>unreg</td>
      <td>new</td>
      <td>active</td>
      <td>unactive</td>
      <td>return</td>
      <td>active</td>
      <td>active</td>
      <td>active</td>
      <td>unactive</td>
      <td>return</td>
      <td>active</td>
      <td>active</td>
      <td>active</td>
    </tr>
    <tr>
      <th>18287</th>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>unreg</td>
      <td>new</td>
      <td>unactive</td>
      <td>lost</td>
      <td>lost</td>
      <td>lost</td>
      <td>return</td>
      <td>unactive</td>
      <td>lost</td>
    </tr>
  </tbody>
</table>
<p>4190 rows × 13 columns</p>
</div>




```python
#将不是新消用户排除，统计不同分层每月的用户量
purchase_status_counts=pivoted_purchase_status.replace('unreg',np.NaN).apply(lambda x:pd.value_counts(x))
purchase_status_counts
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>2010-12-01</th>
      <th>2011-01-01</th>
      <th>2011-02-01</th>
      <th>2011-03-01</th>
      <th>2011-04-01</th>
      <th>2011-05-01</th>
      <th>2011-06-01</th>
      <th>2011-07-01</th>
      <th>2011-08-01</th>
      <th>2011-09-01</th>
      <th>2011-10-01</th>
      <th>2011-11-01</th>
      <th>2011-12-01</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>active</th>
      <td>nan</td>
      <td>302.00000</td>
      <td>238</td>
      <td>257</td>
      <td>267</td>
      <td>332</td>
      <td>380</td>
      <td>342</td>
      <td>356</td>
      <td>385</td>
      <td>454</td>
      <td>577</td>
      <td>347</td>
    </tr>
    <tr>
      <th>lost</th>
      <td>nan</td>
      <td>nan</td>
      <td>425</td>
      <td>668</td>
      <td>864</td>
      <td>1124</td>
      <td>1269</td>
      <td>1523</td>
      <td>1764</td>
      <td>1792</td>
      <td>1776</td>
      <td>1812</td>
      <td>2352</td>
    </tr>
    <tr>
      <th>new</th>
      <td>833.00000</td>
      <td>399.00000</td>
      <td>359</td>
      <td>442</td>
      <td>288</td>
      <td>277</td>
      <td>231</td>
      <td>193</td>
      <td>166</td>
      <td>291</td>
      <td>356</td>
      <td>317</td>
      <td>38</td>
    </tr>
    <tr>
      <th>return</th>
      <td>nan</td>
      <td>nan</td>
      <td>106</td>
      <td>220</td>
      <td>250</td>
      <td>392</td>
      <td>328</td>
      <td>367</td>
      <td>356</td>
      <td>518</td>
      <td>509</td>
      <td>704</td>
      <td>202</td>
    </tr>
    <tr>
      <th>unactive</th>
      <td>nan</td>
      <td>531.00000</td>
      <td>463</td>
      <td>446</td>
      <td>652</td>
      <td>473</td>
      <td>621</td>
      <td>597</td>
      <td>546</td>
      <td>493</td>
      <td>740</td>
      <td>742</td>
      <td>1251</td>
    </tr>
  </tbody>
</table>
</div>




```python
purchase_status_counts.fillna(0).T
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>active</th>
      <th>lost</th>
      <th>new</th>
      <th>return</th>
      <th>unactive</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2010-12-01</th>
      <td>0.00000</td>
      <td>0.00000</td>
      <td>833.00000</td>
      <td>0.00000</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>2011-01-01</th>
      <td>302.00000</td>
      <td>0.00000</td>
      <td>399.00000</td>
      <td>0.00000</td>
      <td>531.00000</td>
    </tr>
    <tr>
      <th>2011-02-01</th>
      <td>238.00000</td>
      <td>425.00000</td>
      <td>359.00000</td>
      <td>106.00000</td>
      <td>463.00000</td>
    </tr>
    <tr>
      <th>2011-03-01</th>
      <td>257.00000</td>
      <td>668.00000</td>
      <td>442.00000</td>
      <td>220.00000</td>
      <td>446.00000</td>
    </tr>
    <tr>
      <th>2011-04-01</th>
      <td>267.00000</td>
      <td>864.00000</td>
      <td>288.00000</td>
      <td>250.00000</td>
      <td>652.00000</td>
    </tr>
    <tr>
      <th>2011-05-01</th>
      <td>332.00000</td>
      <td>1124.00000</td>
      <td>277.00000</td>
      <td>392.00000</td>
      <td>473.00000</td>
    </tr>
    <tr>
      <th>2011-06-01</th>
      <td>380.00000</td>
      <td>1269.00000</td>
      <td>231.00000</td>
      <td>328.00000</td>
      <td>621.00000</td>
    </tr>
    <tr>
      <th>2011-07-01</th>
      <td>342.00000</td>
      <td>1523.00000</td>
      <td>193.00000</td>
      <td>367.00000</td>
      <td>597.00000</td>
    </tr>
    <tr>
      <th>2011-08-01</th>
      <td>356.00000</td>
      <td>1764.00000</td>
      <td>166.00000</td>
      <td>356.00000</td>
      <td>546.00000</td>
    </tr>
    <tr>
      <th>2011-09-01</th>
      <td>385.00000</td>
      <td>1792.00000</td>
      <td>291.00000</td>
      <td>518.00000</td>
      <td>493.00000</td>
    </tr>
    <tr>
      <th>2011-10-01</th>
      <td>454.00000</td>
      <td>1776.00000</td>
      <td>356.00000</td>
      <td>509.00000</td>
      <td>740.00000</td>
    </tr>
    <tr>
      <th>2011-11-01</th>
      <td>577.00000</td>
      <td>1812.00000</td>
      <td>317.00000</td>
      <td>704.00000</td>
      <td>742.00000</td>
    </tr>
    <tr>
      <th>2011-12-01</th>
      <td>347.00000</td>
      <td>2352.00000</td>
      <td>38.00000</td>
      <td>202.00000</td>
      <td>1251.00000</td>
    </tr>
  </tbody>
</table>
</div>




```python
purchase_status_counts.fillna(0).T.plot.area(title='每月不分层的用户人数',figsize=(12,8))
```




    <matplotlib.axes._subplots.AxesSubplot at 0x234230dd5c0>




![png](output_30_1.png)


绿色和黄色区域可以不看，由于绿色是新用户的数量，数据源只是某时间段的消费行为，而流失用户会进行累加导致数据有误差。可以看出，活跃用户和回流用户数比较稳定且在缓慢增长，观察这两个数据的增长情况


```python
fcpurchase_rate=purchase_status_counts/purchase_status_counts.sum()

plt.subplot(211)
fcpurchase_rate.loc['return'].plot(title='回流用户占比',figsize=(12,8))
plt.subplot(212)
fcpurchase_rate.loc['active'].plot(title='活跃用户占比变化',figsize=(12,8))
```




    <matplotlib.axes._subplots.AxesSubplot at 0x234231fa4a8>




![png](output_32_1.png)


2011截止11月年期间，回流率占比在上升，活跃率在此期间保持稳定，但是12月份，两者都陡然回落


```python
user_purchase = df_order[['CustomerID', 'Quantity', 'Date','Amount']]
order_date_min = user_purchase.groupby('CustomerID').Date.min()
order_date_max=user_purchase.groupby('CustomerID').Date.max()
(order_date_max-order_date_min).head()
```




    CustomerID
    12347   365 days
    12348   110 days
    12349     0 days
    12350     0 days
    12352   260 days
    Name: Date, dtype: timedelta64[ns]




```python

```


```python
#查看生命周期详细数据
(order_date_max - order_date_min).describe()
```




    count                        4190
    mean     128 days 21:27:03.866348
    std      131 days 13:54:37.445430
    min               0 days 00:00:00
    25%               0 days 00:00:00
    50%              90 days 00:00:00
    75%             250 days 00:00:00
    max             373 days 00:00:00
    Name: Date, dtype: object



平均生命周期为128天，方差为131天，数据离散程度大，大部分为一次性消费用户，下面将这部分用户筛选过后在进行分析，


```python
life_time = (order_date_max - order_date_min).reset_index()
life_time=life_time.set_index('CustomerID').applymap(lambda x:x.days)#timedelta64[ns]可通过days属性获得天数数值
life_time[life_time.Date>0].describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>2656.00000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>203.33773</td>
    </tr>
    <tr>
      <th>std</th>
      <td>110.33316</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.00000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>107.00000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>210.00000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>301.00000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>373.00000</td>
    </tr>
  </tbody>
</table>
</div>



消费一次以上的平均用户生命周期是203天。从策略看，用户首次消费后应该花费更多的引导其进行多次消费，提供生命周期，这会带来2倍的增量。


```python
#看看留存率的表现
#留存率指用户在第一次消费后，有多少比率进行第二次消费。和回流率的区别是留存倾向于计算第一次消费，并且有多个时间窗口。
```


```python
#计算用户每次消费与首次消费的时间差
user_purchase_retention=pd.merge(left=user_purchase, right=order_date_min.reset_index(), how='inner',on='CustomerID', suffixes=('','_min'))
user_purchase_retention['Date_diff']=user_purchase_retention['Date']-user_purchase_retention['Date_min']

date_transfer=lambda x: x/ np.timedelta64(1,'D')#也可以使用days属性
user_purchase_retention['Date_diff']=user_purchase_retention['Date_diff'].apply(date_transfer)
user_purchase_retention
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>CustomerID</th>
      <th>Quantity</th>
      <th>Date</th>
      <th>Amount</th>
      <th>Date_min</th>
      <th>Date_diff</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>12431</td>
      <td>95</td>
      <td>2010-12-01</td>
      <td>256.25000</td>
      <td>2010-12-01</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>12431</td>
      <td>92</td>
      <td>2010-12-17</td>
      <td>236.40000</td>
      <td>2010-12-01</td>
      <td>16.00000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>12431</td>
      <td>94</td>
      <td>2011-01-28</td>
      <td>249.78000</td>
      <td>2010-12-01</td>
      <td>58.00000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>12431</td>
      <td>268</td>
      <td>2011-02-17</td>
      <td>506.40000</td>
      <td>2010-12-01</td>
      <td>78.00000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>12431</td>
      <td>73</td>
      <td>2011-02-27</td>
      <td>203.75000</td>
      <td>2010-12-01</td>
      <td>88.00000</td>
    </tr>
    <tr>
      <th>5</th>
      <td>12431</td>
      <td>168</td>
      <td>2011-05-12</td>
      <td>347.96000</td>
      <td>2010-12-01</td>
      <td>162.00000</td>
    </tr>
    <tr>
      <th>6</th>
      <td>12431</td>
      <td>105</td>
      <td>2011-05-23</td>
      <td>260.39000</td>
      <td>2010-12-01</td>
      <td>173.00000</td>
    </tr>
    <tr>
      <th>7</th>
      <td>12431</td>
      <td>162</td>
      <td>2011-07-19</td>
      <td>387.62000</td>
      <td>2010-12-01</td>
      <td>230.00000</td>
    </tr>
    <tr>
      <th>8</th>
      <td>12431</td>
      <td>178</td>
      <td>2011-07-24</td>
      <td>467.30000</td>
      <td>2010-12-01</td>
      <td>235.00000</td>
    </tr>
    <tr>
      <th>9</th>
      <td>12431</td>
      <td>86</td>
      <td>2011-08-12</td>
      <td>191.16000</td>
      <td>2010-12-01</td>
      <td>254.00000</td>
    </tr>
    <tr>
      <th>10</th>
      <td>12431</td>
      <td>222</td>
      <td>2011-10-06</td>
      <td>434.06000</td>
      <td>2010-12-01</td>
      <td>309.00000</td>
    </tr>
    <tr>
      <th>11</th>
      <td>12431</td>
      <td>28</td>
      <td>2011-10-06</td>
      <td>89.80000</td>
      <td>2010-12-01</td>
      <td>309.00000</td>
    </tr>
    <tr>
      <th>12</th>
      <td>12431</td>
      <td>194</td>
      <td>2011-10-10</td>
      <td>302.68000</td>
      <td>2010-12-01</td>
      <td>313.00000</td>
    </tr>
    <tr>
      <th>13</th>
      <td>12433</td>
      <td>1020</td>
      <td>2010-12-01</td>
      <td>1289.32000</td>
      <td>2010-12-01</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>14</th>
      <td>12433</td>
      <td>984</td>
      <td>2010-12-08</td>
      <td>1279.72000</td>
      <td>2010-12-01</td>
      <td>7.00000</td>
    </tr>
    <tr>
      <th>15</th>
      <td>12433</td>
      <td>963</td>
      <td>2011-09-09</td>
      <td>1964.69000</td>
      <td>2010-12-01</td>
      <td>282.00000</td>
    </tr>
    <tr>
      <th>16</th>
      <td>12433</td>
      <td>574</td>
      <td>2011-10-27</td>
      <td>1211.62000</td>
      <td>2010-12-01</td>
      <td>330.00000</td>
    </tr>
    <tr>
      <th>17</th>
      <td>12433</td>
      <td>497</td>
      <td>2011-11-30</td>
      <td>1093.51000</td>
      <td>2010-12-01</td>
      <td>364.00000</td>
    </tr>
    <tr>
      <th>18</th>
      <td>12433</td>
      <td>497</td>
      <td>2011-12-09</td>
      <td>1073.71000</td>
      <td>2010-12-01</td>
      <td>373.00000</td>
    </tr>
    <tr>
      <th>19</th>
      <td>12433</td>
      <td>12</td>
      <td>2011-12-09</td>
      <td>19.80000</td>
      <td>2010-12-01</td>
      <td>373.00000</td>
    </tr>
    <tr>
      <th>20</th>
      <td>12583</td>
      <td>362</td>
      <td>2010-12-01</td>
      <td>737.66000</td>
      <td>2010-12-01</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>21</th>
      <td>12583</td>
      <td>280</td>
      <td>2011-01-07</td>
      <td>566.00000</td>
      <td>2010-12-01</td>
      <td>37.00000</td>
    </tr>
    <tr>
      <th>22</th>
      <td>12583</td>
      <td>192</td>
      <td>2011-02-10</td>
      <td>172.32000</td>
      <td>2010-12-01</td>
      <td>71.00000</td>
    </tr>
    <tr>
      <th>23</th>
      <td>12583</td>
      <td>236</td>
      <td>2011-03-11</td>
      <td>392.60000</td>
      <td>2010-12-01</td>
      <td>100.00000</td>
    </tr>
    <tr>
      <th>24</th>
      <td>12583</td>
      <td>228</td>
      <td>2011-05-23</td>
      <td>260.56000</td>
      <td>2010-12-01</td>
      <td>173.00000</td>
    </tr>
    <tr>
      <th>25</th>
      <td>12583</td>
      <td>102</td>
      <td>2011-06-12</td>
      <td>184.14000</td>
      <td>2010-12-01</td>
      <td>193.00000</td>
    </tr>
    <tr>
      <th>26</th>
      <td>12583</td>
      <td>110</td>
      <td>2011-06-21</td>
      <td>224.90000</td>
      <td>2010-12-01</td>
      <td>202.00000</td>
    </tr>
    <tr>
      <th>27</th>
      <td>12583</td>
      <td>160</td>
      <td>2011-07-08</td>
      <td>215.40000</td>
      <td>2010-12-01</td>
      <td>219.00000</td>
    </tr>
    <tr>
      <th>28</th>
      <td>12583</td>
      <td>170</td>
      <td>2011-08-25</td>
      <td>225.10000</td>
      <td>2010-12-01</td>
      <td>267.00000</td>
    </tr>
    <tr>
      <th>29</th>
      <td>12583</td>
      <td>202</td>
      <td>2011-09-21</td>
      <td>440.00000</td>
      <td>2010-12-01</td>
      <td>294.00000</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>16790</th>
      <td>13153</td>
      <td>114</td>
      <td>2011-12-04</td>
      <td>140.46000</td>
      <td>2011-12-04</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16791</th>
      <td>15773</td>
      <td>119</td>
      <td>2011-12-04</td>
      <td>128.80000</td>
      <td>2011-12-04</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16792</th>
      <td>16535</td>
      <td>302</td>
      <td>2011-12-04</td>
      <td>384.63000</td>
      <td>2011-12-04</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16793</th>
      <td>16988</td>
      <td>37</td>
      <td>2011-12-04</td>
      <td>67.87000</td>
      <td>2011-12-04</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16794</th>
      <td>17936</td>
      <td>256</td>
      <td>2011-12-04</td>
      <td>337.24000</td>
      <td>2011-12-04</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16795</th>
      <td>12367</td>
      <td>112</td>
      <td>2011-12-05</td>
      <td>138.30000</td>
      <td>2011-12-05</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16796</th>
      <td>13790</td>
      <td>424</td>
      <td>2011-12-05</td>
      <td>236.84000</td>
      <td>2011-12-05</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16797</th>
      <td>14219</td>
      <td>76</td>
      <td>2011-12-05</td>
      <td>73.44000</td>
      <td>2011-12-05</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16798</th>
      <td>15097</td>
      <td>166</td>
      <td>2011-12-05</td>
      <td>215.08000</td>
      <td>2011-12-05</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16799</th>
      <td>16597</td>
      <td>44</td>
      <td>2011-12-05</td>
      <td>44.24000</td>
      <td>2011-12-05</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16800</th>
      <td>17383</td>
      <td>150</td>
      <td>2011-12-05</td>
      <td>199.29000</td>
      <td>2011-12-05</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16801</th>
      <td>18015</td>
      <td>157</td>
      <td>2011-12-05</td>
      <td>120.03000</td>
      <td>2011-12-05</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16802</th>
      <td>12442</td>
      <td>181</td>
      <td>2011-12-06</td>
      <td>144.06000</td>
      <td>2011-12-06</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16803</th>
      <td>12478</td>
      <td>225</td>
      <td>2011-12-06</td>
      <td>479.59000</td>
      <td>2011-12-06</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16804</th>
      <td>12650</td>
      <td>250</td>
      <td>2011-12-06</td>
      <td>242.44000</td>
      <td>2011-12-06</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16805</th>
      <td>14578</td>
      <td>84</td>
      <td>2011-12-06</td>
      <td>111.51000</td>
      <td>2011-12-06</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16806</th>
      <td>15318</td>
      <td>534</td>
      <td>2011-12-06</td>
      <td>284.90000</td>
      <td>2011-12-06</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16807</th>
      <td>15992</td>
      <td>16</td>
      <td>2011-12-06</td>
      <td>27.04000</td>
      <td>2011-12-06</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16808</th>
      <td>16528</td>
      <td>130</td>
      <td>2011-12-06</td>
      <td>175.02000</td>
      <td>2011-12-06</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16809</th>
      <td>16569</td>
      <td>87</td>
      <td>2011-12-06</td>
      <td>76.50000</td>
      <td>2011-12-06</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16810</th>
      <td>17914</td>
      <td>287</td>
      <td>2011-12-06</td>
      <td>237.75000</td>
      <td>2011-12-06</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16811</th>
      <td>14087</td>
      <td>221</td>
      <td>2011-12-07</td>
      <td>188.12000</td>
      <td>2011-12-07</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16812</th>
      <td>14204</td>
      <td>80</td>
      <td>2011-12-07</td>
      <td>138.58000</td>
      <td>2011-12-07</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16813</th>
      <td>15471</td>
      <td>232</td>
      <td>2011-12-07</td>
      <td>371.13000</td>
      <td>2011-12-07</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16814</th>
      <td>13298</td>
      <td>24</td>
      <td>2011-12-08</td>
      <td>90.00000</td>
      <td>2011-12-08</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16815</th>
      <td>13436</td>
      <td>69</td>
      <td>2011-12-08</td>
      <td>113.54000</td>
      <td>2011-12-08</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16816</th>
      <td>14520</td>
      <td>12</td>
      <td>2011-12-08</td>
      <td>10.20000</td>
      <td>2011-12-08</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16817</th>
      <td>14569</td>
      <td>29</td>
      <td>2011-12-08</td>
      <td>80.09000</td>
      <td>2011-12-08</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16818</th>
      <td>15520</td>
      <td>194</td>
      <td>2011-12-08</td>
      <td>320.70000</td>
      <td>2011-12-08</td>
      <td>0.00000</td>
    </tr>
    <tr>
      <th>16819</th>
      <td>12713</td>
      <td>499</td>
      <td>2011-12-09</td>
      <td>722.85000</td>
      <td>2011-12-09</td>
      <td>0.00000</td>
    </tr>
  </tbody>
</table>
<p>16820 rows × 6 columns</p>
</div>




```python
##将时间分为0～3天内，3～7天内，7～15天等
bin=[0,3,7,15,30,60,90,180,373]
user_purchase_retention['Date_diff_bin']=pd.cut(user_purchase_retention['Date_diff'],bins=bin)
#用pivot_table数据透视，获得的结果是用户在第一次消费之后，在后续各时间段内的消费总额。
user_purchase_retention['Date_diff_bin']=user_purchase_retention['Date_diff_bin'].astype(object)
pivoted_retention_amount=user_purchase_retention.pivot_table(index='CustomerID',columns='Date_diff_bin',values='Amount',aggfunc=np.sum)
pivoted_retention_amount.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Date_diff_bin</th>
      <th>(0.0, 3.0]</th>
      <th>(3.0, 7.0]</th>
      <th>(7.0, 15.0]</th>
      <th>(15.0, 30.0]</th>
      <th>(30.0, 60.0]</th>
      <th>(60.0, 90.0]</th>
      <th>(90.0, 180.0]</th>
      <th>(180.0, 373.0]</th>
    </tr>
    <tr>
      <th>CustomerID</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>12347</th>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>437.14000</td>
      <td>nan</td>
      <td>325.00000</td>
      <td>1901.70000</td>
    </tr>
    <tr>
      <th>12348</th>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>20.40000</td>
      <td>nan</td>
      <td>17.00000</td>
      <td>nan</td>
    </tr>
    <tr>
      <th>12352</th>
      <td>nan</td>
      <td>nan</td>
      <td>70.35000</td>
      <td>120.33000</td>
      <td>120.33000</td>
      <td>nan</td>
      <td>nan</td>
      <td>591.53000</td>
    </tr>
    <tr>
      <th>12356</th>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>267.86000</td>
      <td>nan</td>
      <td>nan</td>
    </tr>
    <tr>
      <th>12358</th>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>nan</td>
      <td>509.16000</td>
      <td>nan</td>
    </tr>
  </tbody>
</table>
</div>




```python
pivoted_retention_amount.mean().plot(kind='bar',figsize=(12,8),title='各时间段总消费金额平均金额')
```




    <matplotlib.axes._subplots.AxesSubplot at 0x23420142dd8>




![png](output_43_1.png)


从4天后，消费金额随着时间增长，下面结合消费用户数量一起分析：


```python
pivoted_retention_count=pivoted_retention_amount.fillna(0).applymap(lambda x: 1 if x>0 else 0)
(pivoted_retention_count.sum()/pivoted_retention_count.count()).plot(kind='bar',figsize=(12,8),color='r',title='留存率')

```




    <matplotlib.axes._subplots.AxesSubplot at 0x23423224dd8>




![png](output_45_1.png)


    前期留存率较低，30天内的留存率表现较差，均不超过20%，峰值在90-180内范围，达到60%，结合60%，结合消费金额看，在平台建立忠诚度后，消费的金额与15天内的相比，增加2-4倍，建议做好不同时期的用户运营，放长线钓大鱼，。下面分析用户购买间隔时间，给出运营时间点的建议。


```python
def diff1(group):
    d=group.Date_diff-group.Date_diff.shift(1)
    return d 
last_diff=user_purchase_retention.groupby('CustomerID').apply(diff1)#groupby不一定要聚合
last_diff.hist(figsize=(10,6),bins=25)
```




    <matplotlib.axes._subplots.AxesSubplot at 0x2342082d470>




![png](output_47_1.png)


直方图符合典型的长尾分布，大部分用户的消费间隔确实比较短。最好的运营策略的时间点在消费后的30天内，


```python
#RFM模型构建
```


```python
df_order.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Date</th>
      <th>Month</th>
      <th>CustomerID</th>
      <th>InvoiceNo</th>
      <th>Quantity</th>
      <th>Amount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2010-12-01</td>
      <td>2010-12-01</td>
      <td>12431</td>
      <td>536389</td>
      <td>95</td>
      <td>256.25000</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2010-12-01</td>
      <td>2010-12-01</td>
      <td>12433</td>
      <td>536532</td>
      <td>1020</td>
      <td>1289.32000</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2010-12-01</td>
      <td>2010-12-01</td>
      <td>12583</td>
      <td>536370</td>
      <td>362</td>
      <td>737.66000</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2010-12-01</td>
      <td>2010-12-01</td>
      <td>12662</td>
      <td>536527</td>
      <td>156</td>
      <td>243.48000</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2010-12-01</td>
      <td>2010-12-01</td>
      <td>12748</td>
      <td>536521</td>
      <td>1</td>
      <td>4.95000</td>
    </tr>
  </tbody>
</table>
</div>




```python
from datetime import date
now=date(2011,12,31) #选择时间，数据集种包含的日期的最后一天
#按照顾客ID分类，统计计算消费次数、消费总金额以及最近一次交易
rfm=df_order.groupby('CustomerID').agg({'Date':lambda x: (now-x.max()).days,
                                       "InvoiceNo":lambda x: len(x),
                                       'Amount':lambda x: x.mean()})
rfm=rfm.rename(columns={'Date':'Recency','InvoiceNo': 'Frequency','Amount': 'Monetary'})#这里生成新的datefrme了，可以使咏inplace参数
rfm.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Recency</th>
      <th>Frequency</th>
      <th>Monetary</th>
    </tr>
    <tr>
      <th>CustomerID</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>12347</th>
      <td>24</td>
      <td>7</td>
      <td>473.53286</td>
    </tr>
    <tr>
      <th>12348</th>
      <td>270</td>
      <td>3</td>
      <td>30.06667</td>
    </tr>
    <tr>
      <th>12349</th>
      <td>40</td>
      <td>1</td>
      <td>984.15000</td>
    </tr>
    <tr>
      <th>12350</th>
      <td>332</td>
      <td>1</td>
      <td>294.40000</td>
    </tr>
    <tr>
      <th>12352</th>
      <td>58</td>
      <td>7</td>
      <td>161.56286</td>
    </tr>
  </tbody>
</table>
</div>




```python
quantiles=rfm.quantile(q=[0.5])
#用0和1划分R、F、M三列数据
rfmsegmentation = rfm 
rfmsegmentation['R_Quantile']=rfmsegmentation['Recency'].map(lambda x:1 if x<=quantiles['Recency'][0.5] else 0  )
rfmsegmentation['F_Quantile']=rfmsegmentation['Frequency'].map(lambda x : 1 if x>quantiles['Frequency'][0.5] else 0 )
rfmsegmentation['M_Quantile'] = rfmsegmentation['Monetary'].map(lambda x:1 if x>quantiles['Monetary'][0.5] else 0)
#合并RFM
rfmsegmentation['RFM']=rfmsegmentation['R_Quantile'].map(str)+rfmsegmentation['F_Quantile'].map(str)+rfmsegmentation.M_Quantile.map(str)
#划分等级
def rfmclass(data):
    if data=='111':
        return '重要价值客户'
    elif data=='011':
        return '重要唤回客户'
    elif data=='101':
        return '重要深耕客户'
    elif data=='001':
        return '重要挽留客户'
    elif data=='110':
        return '潜力客户'
    elif data=='100':
        return '新客户'
    elif data=='010':
        return '一般维持客户'
    else:
        return '流失客户'
rfmsegmentation['RFMclass']=rfmsegmentation['RFM'].apply(rfmclass)
rfmsegmentation.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Recency</th>
      <th>Frequency</th>
      <th>Monetary</th>
      <th>R_Quantile</th>
      <th>F_Quantile</th>
      <th>M_Quantile</th>
      <th>RFM</th>
      <th>RFMclass</th>
    </tr>
    <tr>
      <th>CustomerID</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>12347</th>
      <td>24</td>
      <td>7</td>
      <td>473.53286</td>
      <td>1</td>
      <td>1</td>
      <td>1</td>
      <td>111</td>
      <td>重要价值客户</td>
    </tr>
    <tr>
      <th>12348</th>
      <td>270</td>
      <td>3</td>
      <td>30.06667</td>
      <td>0</td>
      <td>1</td>
      <td>0</td>
      <td>010</td>
      <td>一般维持客户</td>
    </tr>
    <tr>
      <th>12349</th>
      <td>40</td>
      <td>1</td>
      <td>984.15000</td>
      <td>1</td>
      <td>0</td>
      <td>1</td>
      <td>101</td>
      <td>重要深耕客户</td>
    </tr>
    <tr>
      <th>12350</th>
      <td>332</td>
      <td>1</td>
      <td>294.40000</td>
      <td>0</td>
      <td>0</td>
      <td>1</td>
      <td>001</td>
      <td>重要挽留客户</td>
    </tr>
    <tr>
      <th>12352</th>
      <td>58</td>
      <td>7</td>
      <td>161.56286</td>
      <td>1</td>
      <td>1</td>
      <td>0</td>
      <td>110</td>
      <td>潜力客户</td>
    </tr>
  </tbody>
</table>
</div>




```python
quantiles['Recency'][0.5]
```




    72.0



  每月的消费总金额、销量等都是随着时间不短上涨，在9-11月这段时间上涨的幅度最大，具体的因素可以考察近期的渠道以及营销活动。
提高用户生命周期，，用户首次消费后应该花费更多的引导其进行多次消费，这会带来2倍的增量。
用户的个体消费行为就有一定的规律性，在用户平台建立忠诚度后，消费的金额与15天内的相比，增加2-4倍。最好的运营策略的时间点在消费后的30天内，其中如果在客户消费的10天内，会进行回购的占比最高。
